#!/bin/bash

LOG_FILE="/var/log/init_elb_script.log"
exec > >(tee -a "$LOG_FILE") 2>&1
exec 2>&1
export DEBIAN_FRONTEND=noninteractive
export HOME=/root
echo "===== B·∫Øt ƒë·∫ßu setup EC2 Ubuntu $(date) ====="
function run_step() {
    echo "---- B·∫Øt ƒë·∫ßu: $1 ----"
    if eval "$2"; then
        echo "‚úÖ Th√†nh c√¥ng: $1"
    else
        echo "‚ùå Th·∫•t b·∫°i: $1"
        exit 1
    fi
    echo "---- K·∫øt th√∫c: $1 ----"
    echo
}

# 1. G·ª≠i th√¥ng b√°o Slack
SLACK_WEBHOOK_URL="https://hooks.slack.com/services/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"
HOSTNAME="TOKTAK"
TIME=$(date +'%Y-%m-%d %H:%M:%S')
INSTANCE_ID="N/A"
PUBLIC_IP=$(curl -s https://api.ipify.org)

SLACK_MESSAGE="üöÄ *EC2 $HOSTNAME b·∫Øt ƒë·∫ßu kh·ªüi  ƒë·ªông!*
‚Ä¢ Instance ID: $INSTANCE_ID
‚Ä¢ Public IP: $PUBLIC_IP
‚Ä¢ Th·ªùi gian: $TIME"

curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"$SLACK_MESSAGE\"}" $SLACK_WEBHOOK_URL


# 1. T·∫°o th∆∞ m·ª•c /var/www v√† ghi test.html
run_step "T·∫°o th∆∞ m·ª•c /var/www" "mkdir -p /var/www"
# 1. X√≥a th∆∞ m·ª•c c≈© n·∫øu t·ªìn t·∫°i v√† t·∫°o /var/www
run_step "X√≥a th∆∞ m·ª•c /var/www/2025_ai_toktak_be/ n·∫øu c√≥" "rm -rf /var/www/2025_ai_toktak_be/"
# 2. C·∫≠p nh·∫≠t h·ªá th·ªëng
run_step "C·∫≠p nh·∫≠t h·ªá th·ªëng" "apt update -y && apt upgrade -y"

run_step "C√†i build-essential, gfortran, python3.12-dev, libatlas, libopenblas" "\
apt install -y build-essential gfortran python3.12-dev libatlas-base-dev libopenblas-dev liblapack-dev"

run_step "C√†i th∆∞ vi·ªán h·ªá th·ªëng h·ªó tr·ª£ OpenCV (libGL)" "apt install -y libgl1"
# C√†i python3.12 v√† venv n·∫øu ch∆∞a c√≥
run_step "C√†i ƒë·∫∑t Python 3.12 v√† venv" "\
apt install -y python3.12 python3.12-venv"
# 3. C√†i git
run_step "C√†i Git" "apt install -y git"
# 5. Clone m√£ ngu·ªìn GitLab (ch·ªâ nh√°nh main)
GIT_REPO_URL="https://chibao2704%40gmail.com:haynhi%40123@gitlab.com/vodaplayvietnam/2025_ai_toktak_be.git"
run_step "Clone m√£ ngu·ªìn nh√°nh elb_main t·ª´ GitLab v·ªÅ /var/www/2025_ai_toktak_be" \
"git clone --branch elb_main --single-branch $GIT_REPO_URL /var/www/2025_ai_toktak_be"
run_step "Th√™m th∆∞ m·ª•c git v√†o safe.directory" "\
git config --global --add safe.directory /var/www/2025_ai_toktak_be"
run_step "Gi·∫£i m√£ file elb_env.enc" "\
cd /var/www/2025_ai_toktak_be && \
openssl enc -d -aes-256-cbc -pbkdf2 -in elb_env.enc -out .env -pass pass:vodaplay987654321"
# 6. Setup venv, pip v√† th∆∞ m·ª•c log
run_step "Thi·∫øt l·∫≠p venv v√† c√†i ƒë·∫∑t y√™u c·∫ßu Python" "\
cd /var/www/2025_ai_toktak_be && \
python3.12 -m venv venv && \
source venv/bin/activate && \
curl -sS https://bootstrap.pypa.io/get-pip.py | python3.12 && \
pip install -r requirements.txt"
run_step "T·∫°o th∆∞ m·ª•c logs v√† c·∫•p quy·ªÅn" "\
mkdir -p /var/www/logs_toktak && chmod -R 777 /var/www/logs_toktak"
run_step "Copy v√† ph√¢n quy·ªÅn run_services.sh" "\
cp elb_start.sh run_services.sh && chmod 777 run_services.sh"
# 7. Copy file service toktak t·ª´ source sang systemd
run_step "Copy file elb_toktak.service sang /etc/systemd/system/toktak.service" "\
cp /var/www/2025_ai_toktak_be/elb_toktak.service /etc/systemd/system/toktak.service"
run_step "Reload systemd, enable & start service" "\
systemctl daemon-reexec && \
systemctl daemon-reload && \
systemctl enable toktak && \
systemctl start toktak"
# 8. C√†i Nginx v√† c·∫•u h√¨nh reverse proxy n·ªôi b·ªô
run_step "C√†i ƒë·∫∑t Nginx" "apt install -y nginx"
run_step "T·∫°o th∆∞ m·ª•c log cho Nginx" "mkdir -p /var/www/logs && chmod -R 777 /var/www/logs"
# 8.1 S·ª≠a quy·ªÅn th∆∞ m·ª•c logs
run_step "S·ª≠a quy·ªÅn /var/www/2025_ai_toktak_be/logs v√† /var/www/logs" "\
mkdir -p /var/www/2025_ai_toktak_be/logs && \
chmod -R 777 /var/www/2025_ai_toktak_be/logs && \
chmod -R 777 /var/www/logs"
run_step "Copy file c·∫•u h√¨nh elb_api.toktak.ai.conf sang /etc/nginx/conf.d/" "\
cp /var/www/2025_ai_toktak_be/elb_api.toktak.ai.conf /etc/nginx/conf.d/api.toktak.ai"
run_step "Ki·ªÉm tra c·∫•u h√¨nh Nginx h·ª£p l·ªá" "nginx -t"
run_step "Kh·ªüi ƒë·ªông l·∫°i Nginx" "systemctl enable nginx && systemctl restart nginx"
# 9. Ki·ªÉm tra ph·∫£n h·ªìi t·ª´ Flask app t·∫°i curl http://127.0.0.1:8000
run_step "Ki·ªÉm tra ph·∫£n h·ªìi Flask app" "\
curl -s --max-time 10 http://127.0.0.1:8000 | grep -q '\"message\":\"Welcome to the Flask API\"'"

# 10. T·∫£i CPClient t·ª´ S3 v√† c·∫•p quy·ªÅn
run_step "T·∫£i CPClient t·ª´ S3 v·ªÅ /var/www/cpclient/" "\
mkdir -p /var/www/cpclient && \
curl -o /var/www/cpclient/CPClient_linux_x64 https://toktaks3.s3.ap-northeast-2.amazonaws.com/nice/Linux/CPClient_linux_x64 && \
chmod -R 777 /var/www/cpclient"

echo "===== K·∫øt th√∫c setup EC2 Ubuntu $(date) ====="

# 10. G·ª≠i th√¥ng b√°o Slack
SLACK_WEBHOOK_URL="https://hooks.slack.com/services/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"
HOSTNAME="TOKTAK"
TIME=$(date +'%Y-%m-%d %H:%M:%S')
INSTANCE_ID="N/A"
PUBLIC_IP=$(curl -s https://api.ipify.org)

SLACK_MESSAGE="üöÄ *EC2 $HOSTNAME ƒë√£ kh·ªüi ƒë·ªông xong!*
‚Ä¢ Instance ID: $INSTANCE_ID
‚Ä¢ Public IP: $PUBLIC_IP
‚Ä¢ Th·ªùi gian: $TIME"

curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"$SLACK_MESSAGE\"}" $SLACK_WEBHOOK_URL